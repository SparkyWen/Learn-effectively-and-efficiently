# TXT 批量合并器（merge_txt_gui.py）

`merge_txt_gui.py` 是一个 **Tkinter 图形界面工具**，用于将某个文件夹内的多个 `.txt` 文件**按批次合并**输出为若干个新的 `.txt` 文件。它面向“文本文件很多、编码不统一、需要按顺序稳定合并、并希望可视化进度与日志”的场景。

该脚本 **仅依赖 Python 标准库**，无需安装第三方依赖。

---

## 主要特性

- ✅ **选择输入/输出文件夹**（GUI 操作）
- ✅ **每 N 个 .txt 合并为 1 个输出文件**（可配置 batch size）
- ✅ **并发读取**（线程数可控，提升读取大量文件的速度）
- ✅ **标题插入**：每篇文本合并时可插入标题（来源可选：文件名 / 首个非空行）
- ✅ **避免重复标题**：若正文开头已包含标题，则不重复插入
- ✅ **统一文档间空行**：可设置每篇文本之间插入的空行数
- ✅ **可选分隔符行**：每篇后可插入自定义分隔线
- ✅ **稳定排序输出**：默认“自然排序”（file2 在 file10 前），也支持字典序 / 按修改时间排序
- ✅ **实时进度条 + 滚动日志**：可看到当前正在处理哪个文件、已完成多少
- ✅ **多编码回退读取**：自动尝试多种编码（utf-8/gbk/gb18030/big5/utf-16/utf-32 等），最大程度避免乱码/读取失败
- ✅ **支持取消**：任务执行中可点击“取消”停止

---

## 适用场景

- 你有大量 `.txt`，想按数量分组（例如每 10 个合并成 1 个）
- 文件编码可能不一致（部分 utf-8，部分 gbk 等），不想手动统一编码
- 文件名带数字（1、2、10……），想按“人类直觉”的顺序合并
- 需要可视化进度与日志，不想在命令行里盯着跑

---

## 脚本整体工作流程（你点“开始合并”后发生了什么）

1. **读取 GUI 参数**
   - 输入文件夹、输出文件夹
   - 每份合并数量（batch size）
   - 线程数（用于并发读取）
   - 文档间空行数
   - 是否插入分隔符行与分隔符内容
   - 标题来源与是否避免重复标题
   - 输出编码
   - 排序方式

2. **列出输入目录中所有 `.txt`（不递归）**
   - 默认按自然顺序排序（`file2` < `file10`）
   - 可切换：字典序 / 按修改时间

3. **并发读取所有文件内容**
   - 使用 `ThreadPoolExecutor(max_workers=threads)`
   - 每个文件读取时，会自动进行编码回退尝试
   - 读取成功：缓存到内存 `content_map`
   - 读取失败：记录错误并跳过（不会导致整体崩溃）

4. **按 batch_size 分组写出**
   - 每组生成一个输出文件
   - 每个输出文件由组内多个 `.txt` 拼接得到
   - 组文件命名包含组序号与范围（便于定位）

5. **更新进度条与日志**
   - 进度条：读取阶段 + 写出阶段共同计数
   - 日志：每一步都会滚动输出时间戳日志

6. **完成或取消**
   - 完成后提示可打开输出文件夹
   - 取消时会尽快停止（读取阶段或写出阶段均可中断）

---

## 输入与输出

### 输入（你需要提供）

#### 1) 输入文件夹
- 选择一个包含若干 `.txt` 的目录
- **只处理该目录下第一层文件**，不递归子文件夹

#### 2) 合并参数（GUI 中可设置）
- **每份合并数量（batch size）**：每 N 个 `.txt` 合并为 1 个输出文件
- **线程数（threads）**：并发读取使用的线程数量（建议 4~16 之间按机器情况调整）
- **文档间空行数（blank lines）**：每篇内容合并后追加多少空行作为间隔
- **分隔符行（可选）**：每篇后追加一行分隔线（例如 `——— 分隔线 ———`）
- **标题来源（可选）**
  - 文件名（默认）：用 `xxx.txt` 的 `xxx` 作为标题
  - 文件首个非空行：把正文中第一个非空行当标题
- **避免重复标题（可选）**
  - 若正文开头已经是该标题，则不重复插入标题（减少冗余）
- **输出编码**
  - `utf-8` / `utf-8-sig` / `gbk` / `gb18030`
- **排序方式**
  - 自然顺序（默认）
  - 字典序（lex）
  - 按修改时间（mtime）

---

### 输出（你会得到什么）

#### 1) 输出目录
- 由你选择的“输出文件夹”决定
- 若你只选了输入文件夹而未选输出文件夹：
  - 脚本会自动设置默认输出为：`<输入文件夹>/merged_output`

#### 2) 输出文件命名规则
每一组输出文件名形如：

- `group_001_1-10.txt`
- `group_002_11-20.txt`

含义：
- `group_001`：第 1 组
- `1-10`：这组理论上对应输入列表中的第 1 到第 10 个（若部分文件读取失败，会自动跳过失败的文件）

#### 3) 输出内容结构（每篇拼接格式）
对每个输入文件（每篇内容）合并时，写出的结构是：

1. **标题（1 行）**
2. **正文（原内容）**
3. 可选：**分隔符行**
4. **统一空行（blank_lines 次）**

整体合并后会：
- 去掉末尾多余空白，确保文件末尾只有一个换行（干净整齐）

---

## GUI 参数说明（逐项解释）

### 路径
- **输入文件夹**：包含 `.txt` 的目录（不递归）
- **输出文件夹**：合并结果输出目录（不存在会自动创建）

### 参数
- **每份合并数量**（batch_size）
  - 每 N 个 `.txt` 合并成 1 个输出文件
  - 例：N=10、共有 25 个文件 → 输出 3 个文件（10 + 10 + 5）
- **线程数**（thread）
  - 仅用于“读取阶段”的并发加速
  - 线程越多不一定越快（受磁盘性能影响），一般 4~16 合理
- **文档间空行数**（blank_lines）
  - 控制每篇内容之间的间隔（例如 3 表示插入 3 个空行）

### 标题来源
- **文件名**
  - 标题为 `path.stem`（不含扩展名）
- **文件首个非空行**
  - 扫描正文，找到第一行 `line.strip()` 非空者作为标题  
  - 常用于正文第一行就是文章标题的情况
- **避免重复标题**
  - 若正文开头已经包含该标题，则不重复插入标题（减少重复）

### 排序方式
- **自然顺序（默认）**
  - 识别文件名中的数字：`file2` 会排在 `file10` 前
- **字典序**
  - 单纯按字符串排序：`file10` 可能排在 `file2` 前（不推荐含数字的场景）
- **按修改时间**
  - 按 `st_mtime` 排序，适合想按编辑顺序合并

### 分隔符行
- 勾选后在每篇末尾追加一行自定义分隔符
- 只有当分隔符输入框 **非空且不全为空白**时才会写入

### 输出编码
- 控制最终写出的合并文件的编码（不会影响读取）
- 推荐默认 `utf-8`（兼容性最好）

---

## 编码回退读取机制（为什么它更“抗乱码/抗报错”）

脚本读取每个 `.txt` 时会依次尝试：

- `utf-8-sig`（自动处理 BOM）
- `utf-8`
- `gb18030`
- `gbk`
- `big5`
- `utf-16`
- `utf-32`

如果以上全部失败：
- 使用二进制读取并以 `utf-8(errors='ignore')` 解码兜底（尽量读出可用文本）

读取成功后会在日志显示“使用的编码”，便于你排查某些文件的来源编码。

---

## 并发与线程安全设计（为什么 GUI 不会卡死、也不会乱）

- “开始合并”后，会启动一个 **后台工作线程**执行实际任务：
  - 避免 Tkinter 主线程被阻塞导致界面卡死
- 工作线程不会直接操作 GUI 控件
  - 而是把日志/进度更新事件放入 `queue.Queue()`
- 主线程通过 `after(100, ...)` 每 100ms 从队列取消息更新 UI
  - 这是 Tkinter 推荐的线程安全刷新方式

---

## 取消行为说明（点击“取消”会怎样）

- 点击“取消”会设置 `_stop_event`
- 读取阶段：
  - 会停止继续收集结果，尽快返回
- 写出阶段：
  - 在每组写出前检查 `_stop_event`，触发后停止继续写
- 取消不一定能“立刻中断”某个正在读取中的线程，但会尽快停止整体流程

---

## 使用步骤（最简）

1. 运行脚本：
   ```bash
   python merge_txt_gui.py

2. 选择“输入文件夹”（包含 `.txt`）
3. 选择或确认“输出文件夹”
4. 设置“每份合并数量 / 线程数 / 标题模式 / 空行数”等参数
5. 点击“开始合并”
6. 等待完成后点击“打开输出文件夹”查看结果

------

## 注意事项与最佳实践

- **文件非常多（上千个）时**：建议线程数设置为 8~16，batch_size 可按你的目标文档大小调整
- **想保持输出顺序稳定**：建议使用默认“自然排序”
- **标题来源选“首个非空行”时**：确保你的文本第一段确实是标题，否则可能把正文第一句当标题
- **输出编码建议 utf-8**：最通用，跨平台、跨软件打开更稳