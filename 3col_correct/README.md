# Excel 表头批改助手（.xlsx）

本工具用于批量修改 Excel 文件（.xlsx）首行表头，其它内容（数据、公式、样式等）尽量保持不变。

---

## 你能用它做什么？

- ✅ 图形界面（Tkinter），无需写命令行参数，上手即用。
- ✅ 批量处理一个文件夹内的所有 `.xlsx`（可选递归子目录），并自动过滤 `~$` 开头的 Excel 临时文件。
- ✅ 表头自定义：支持逗号 / 中文逗号 / 分号 / 换行等分隔方式。
- ✅ Sheet 处理方式可选：所有 Sheet / 仅第一个 Sheet / 只处理指定名称。
- ✅ 输出安全策略：默认输出到新目录；也支持原地覆盖并自动生成 `.bak` 备份。
- ✅ 并行加速：支持线程池 / 进程池两种并行方式，并可设置最大并发数。
- ✅ 日志 + 进度条：实时显示处理进度，支持“取消任务”（会在当前批次结束后停止）。

---

## 项目文件结构

建议你的项目目录长这样（文件名与本项目一致）：

- `excel_header_renamer_gui.py`：主程序（GUI + 批处理逻辑）
- `requirements.txt`：依赖列表（只需要 openpyxl；Tkinter 通常随 Python 自带）
- `excel_header_renamer.config.json`：GUI 的本地配置缓存（上次输入/输出目录与表头内容）
- `run_header_renamer_windows.bat`：Windows 一键启动脚本（自动建 venv 并运行）

---

## 安装与运行

### 方式 A：通用方式（Windows/macOS/Linux）

```bash
python -m venv venv
# Windows: venv\Scripts\activate
# macOS/Linux: source venv/bin/activate
pip install -r requirements.txt
python excel_header_renamer_gui.py
```

### 方式 B：Windows 双击运行（推荐给非开发用户）

直接双击 `run_header_renamer_windows.bat` 自动创建虚拟环境并启动。

------

## 使用指南（GUI 每一项对应什么）

### 1) 输入文件夹

选择一个包含 `.xlsx` 的文件夹。程序会收集该目录下的 `.xlsx` 文件：

- 勾选“递归子目录”则会递归查找（`rglob("*.xlsx")`）。
- 不勾选则只查当前目录（`glob("*.xlsx")`）。

会自动忽略 `~$` 开头的 Excel 临时文件（避免处理中断/报错）。

------

### 2) 目标列名（你想要的表头）

在“目标列名”文本框中输入你想写入的表头。

支持分隔符：`,  ，  ;  ；  换行`（程序会统一替换成逗号后再解析）。

示例：

- 单行：`产品名称, 时间, 行业/应用领域, 官网链接, 一句话介绍（功能与地位）`
- 多行（每行一个列名）也可以

提示：至少需要 1 个列名，否则会提示你补全。

------

### 3) 工作表（Sheet）选择

你可以选择修改哪些工作表：

- **仅第一个 Sheet**：只处理工作簿中的第一个工作表。
- **所有 Sheet**：处理该文件内所有工作表。
- **只处理指定名称**：你输入 Sheet 名列表（逗号/换行分隔），只修改匹配到的那些。

------

### 4) 表头写入策略（三选一，最重要）

该工具只改“第 1 行”的单元格值（表头行）。写入策略决定“写到多少列、是否清空多余列”等行为。

#### 策略 A：只覆盖已有列（不改变列数）【默认推荐】

只改“当前已有列数 ncols”的前 `min(ncols, 目标列数)` 列。

适合：你不确定原表格实际列数、担心误扩列时。

#### 策略 B：覆盖已有列 + 多余列标题清空

对已有列数 ncols 的每一列：

- 有对应目标列名就写目标列名；
- 超出目标列名范围的列头写空字符串 `""`。

适合：你希望“原表格多出来的列标题”全部清空掉。

#### 策略 C：强制按目标列写满（可能超出当前列数）

无视当前列数，按目标列名数量写入第 1 行（可能扩到更多列）。

适合：你明确知道应该有多少列，且希望严格对齐目标列数。

**列数判断说明**：程序会优先用“第一行实际内容（去掉尾部空）”来推断列数，不足时回退到 `ws.max_column`。

------

### 5) 输出方式（强烈建议先用“输出到新目录”）

你有两种输出方式：

#### 输出到新目录（默认更安全）

不改原文件，在输出目录生成新文件。

- 默认输出目录：`<输入目录>/renamed_headers`（如果你没手动选）
- 输出文件名：`原文件名 + 后缀 + .xlsx`（后缀默认 `_renamed`）

#### 原地覆盖（谨慎）

直接覆盖原文件内容。

建议同时勾选“生成备份”：会在旁边生成 `原文件.xlsx.bak.<timestamp>`。

------

### 6) 并行加速

勾选“启用并行”后，可选 `process`（进程）或 `thread`（线程），并设置最大并发数。

程序会根据你的选择使用 `ProcessPoolExecutor` 或 `ThreadPoolExecutor` 执行。

经验建议：文件多 / 文件大 → 优先尝试 `process`。

------

### 7) 取消任务

点击“取消任务”后，会设置停止标记，并提示“将在当前批次结束后停止”。

------

## 输入与输出说明（你关心的“改了什么/没改什么”）

### 输入

- 一个文件夹中的 `.xlsx` 文件（可选递归子目录）
- 你提供的目标列名列表

### 输出

- **不覆盖模式**：在输出目录生成新的 `.xlsx` 文件（文件名默认加 `_renamed` 后缀）
- **覆盖模式**：原文件被写回；可选生成 `.bak` 备份文件

### 它会修改哪些内容？

- 只修改“目标 Sheet 的第 1 行单元格 value”（表头值）
- 其它内容（数据、公式、样式）力求保持不变（基于 openpyxl 的保存机制尽量保留）

------

## 配置文件（excel_header_renamer.config.json）

程序会在同目录下维护一个配置文件 `excel_header_renamer.config.json`，用于记住你上次的：

- 输入目录 `in_dir`
- 输出目录 `out_dir`
- 目标表头文本 `headers_text`

当你再次打开 GUI 时，它会自动读取这些值并回填到界面。

------

## 依赖说明

本项目依赖极少：

- `openpyxl>=3.1`
- `tkinter` 通常随 Python 自带（requirements 里也有备注）

------

## 常见问题（FAQ）

### 1) 为什么只支持 .xlsx？

程序收集文件时只匹配 `*.xlsx`。

### 2) 表头列数不一致，选哪个策略更安全？

优先用“只覆盖已有列（不改变列数）”，避免误扩列或清空不该清空的列头。

### 3) 进程模式在 Windows 下能跑吗？

代码在入口处调用了 `freeze_support()`，对 Windows/打包场景更友好。

### 4) 处理完会发生什么？

任务完成后会弹窗提示成功数，并在 Windows 上尝试自动打开输出目录（或输入目录）。

------

## 安全建议（强烈推荐你这样用）

- 第一次使用：务必选“输出到新目录”，确认效果无误后再考虑原地覆盖。
- 原地覆盖时：建议勾选“生成备份”，避免误操作导致不可逆丢失。