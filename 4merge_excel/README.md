# Excel 合并助手（.xlsx）

本工具用于将一个文件夹中的多个 `.xlsx` 文件批量合并为一个新的 `.xlsx` 输出文件。支持 **图形界面（Tkinter）**、**并行读取加速**、两种合并模式，以及常见的数据清洗与写入选项，适合日常办公与数据整理场景。

---

## 你能用它做什么？

- ✅ **图形界面（Tkinter）**：无需命令行参数，上手即用。
- ✅ **批量合并文件夹内所有 `.xlsx`**：可选递归子目录，并自动跳过 `~$` 开头的 Excel 临时文件。
- ✅ **两种合并模式**：  
  - **合并为一个总表**：所有文件/所有 Sheet 纵向堆叠到一个工作表；超过 Excel 单表行上限会自动分页写入。  
  - **按 Sheet 名分别合并**：同名 Sheet 各自合并输出到多个工作表（同样支持超行分页）。
- ✅ **常用选项**：递归子目录、添加来源文件/Sheet 列、去空行、列并集/交集、按指定列去重、自动列宽、写入引擎选择。
- ✅ **并行读取加速**：支持线程池 / 进程池，文件多时显著加速；界面保持响应。
- ✅ **健壮性**：列名重复自动重命名（`_1/_2`），减少合并异常。

---

## 项目文件结构

建议你的项目目录如下（文件名与本项目一致）：

- `excel_merger_gui.py`：主程序（GUI + 合并逻辑 + 并行读取 + 写入）。
- `requirements.txt`：依赖列表（通常包含 `pandas`、`openpyxl`；可选 `XlsxWriter` 用于更快写入）。
- `excel_merger_gui.config.json`：GUI 配置缓存（记住上次输入目录与输出路径）。
- `run_windows.bat`：Windows 一键启动脚本（自动建 venv、安装依赖并运行）。

---

## 安装与运行

### 方式 A：通用方式（Windows / macOS / Linux）

```bash
python -m venv venv
# Windows:
venv\Scripts\activate
# macOS/Linux:
source venv/bin/activate

pip install -r requirements.txt
python excel_merger_gui.py
```

### 方式 B：Windows 双击运行（推荐给非开发用户）

双击 `run_windows.bat` 自动创建虚拟环境并启动（脚本会自行安装依赖后运行）。

------

## 使用指南（GUI 每一项对应什么）

### 1) 待合并文件夹

选择一个包含 `.xlsx` 文件的文件夹：

- 勾选“递归子文件夹”：会递归查找子目录下的 `.xlsx`。
- 工具会自动跳过 `~$` 开头的 Excel 临时文件（避免读取失败）。
- 若输出文件就在输入目录内，工具会自动把输出文件从输入列表中排除，避免“读自己写自己”。

### 2) 输出 .xlsx 文件

选择最终输出的 `.xlsx` 路径（建议输出到一个“结果目录”，避免覆盖原始文件）。

------

## 合并模式

### 模式 A：合并为一个总表

- 读取所有文件的所有 Sheet，并将数据 **纵向堆叠**到一个输出工作表中（通常命名为 `merged`）。
- 若合并后行数超过 Excel 单表最大行数 **1,048,576**，会自动分页写到：
  - `merged_1`
  - `merged_2`
  - ...

适合场景：

- 你只想得到一个“总表”，统一查看/筛选/透视分析。

------

### 模式 B：按 Sheet 名分别合并（同名 Sheet 各自合并）

- 以 Sheet 名为分组键：同名 Sheet 的数据合并到同名输出 Sheet。
- 若某个 Sheet 合并后超过行上限，会按以下方式分页写出：
  - `SheetName_1`
  - `SheetName_2`
  - ...
- 程序会自动清理不合法的 Sheet 名字符，并保证长度不超过 31。

适合场景：

- 你希望保留“Sheet 结构”，例如多个文件都包含 `Summary`、`Detail` 等同名工作表。

------

## 选项说明

### 1) 递归子文件夹

开启后会扫描输入目录的所有子目录，收集全部 `.xlsx`。

------

### 2) 添加来源列（可选）

用于追溯每行数据来自哪个文件/Sheet：

- 添加来源文件名列：在最前面插入 `source_file`
- 添加来源 Sheet 列：插入 `source_sheet`

适合场景：

- 合并后需要定位某条记录的来源文件、来源工作表。

------

### 3) 去除空行（可选）

开启后会删除“整行全空”的记录，减少无效行。

------

### 4) 列集合策略：并集 / 交集

合并时可选两种列策略：

- **列并集（默认）**：保留所有出现过的列；缺失的列填空（NaN）。
  - 适合：不同文件列结构不完全一致、希望尽量保留信息。
- **列交集**：只保留“所有表都共同拥有”的列，结构更统一但可能丢列。
  - 适合：你只关心每个表都有的公共字段。

------

### 5) 去重字段（可选）

输入列名列表（逗号分隔），按这些字段对合并结果去重。

- 留空：不去重
- 填写：按 `subset=这些列` 去重，保留第一条

建议：

- 去重列必须在最终输出列集中存在（尤其选择“交集”时要注意）。

------

### 6) 自动列宽（可选）

按每列取样估算列宽，写出时自动设置列宽，并冻结首行（从第二行开始滚动更方便）。

------

### 7) 写入引擎

- `openpyxl`：默认可用，兼容性好。
- `xlsxwriter`：通常写入更快（需要安装 `XlsxWriter`）。

------

## 并行加速

勾选“启用并行读取”后，可选择：

- **process（进程池）**：通常更适合大量文件/较重的解析场景（更推荐）。
- **thread（线程池）**：适合 I/O 明显、CPU 压力相对小的场景。

“最大并发”用于控制同时读取的文件数量。并发过高可能导致内存压力或磁盘争用，建议逐步调大测试。

> Windows 下使用进程池时，为了更稳定，通常需要入口保护与兼容处理（脚本已考虑该场景）。

------

## 输入与输出说明（改了什么 / 没改什么）

### 输入

- 一个目录中的 `.xlsx` 文件（可选递归子目录）。
- 你在 GUI 中选择的合并模式与选项。

### 输出

- 一个新的 `.xlsx` 文件，包含合并后的工作表（单表模式或多表模式）。

### 数据处理行为说明

- **读取范围**：通常会读取每个文件的所有 Sheet（取决于合并模式与实现）。
- **列名处理**：重复列名会自动加后缀 `_1/_2`，并进行必要的规范化（例如去首尾空格、转字符串等）。
- **空行清理（可选）**：删除全空行。
- **行上限自动分页**：超过 1,048,576 行会自动拆分到多个 Sheet 写出。

------

## 配置文件（excel_merger_gui.config.json）

工具会在同目录下维护一个配置文件，用于记住你上次的：

- 输入目录（例如 `dir`）
- 输出路径（例如 `out`）

下次启动会自动回填到 GUI，减少重复选择路径的操作。

------

## 常见问题（FAQ）

### 1) 为什么只支持 .xlsx？

工具只收集 `*.xlsx` 文件进行合并。

### 2) 合并后超过 Excel 行上限怎么办？

工具会自动分页写入多个工作表（例如 `merged_1/merged_2/...` 或 `SheetName_1/SheetName_2/...`）。

### 3) 哪种列策略更推荐：并集还是交集？

- 结构不一致、想尽量保留信息 → 选 **并集**
- 所有表结构接近、想输出更统一 → 选 **交集**

### 4) GUI 看起来“卡住”了怎么办？

数据量很大时写入可能耗时较长，建议耐心等待；或先减少一次合并的文件数量；必要时关闭“自动列宽”等耗时选项。

### 5) 数据特别大，Excel 承载不下怎么办？

如果合并后体积非常大，Excel 本身不适合长期承载，建议改为导出 CSV 或写入数据库获得更好的可扩展性。

------

## 安全建议

- 建议把输出文件放在独立目录，避免误覆盖原始数据。
- 首次使用建议先用少量文件试跑（确认合并模式、并集/交集、去重字段是否符合预期）。
- 如果你需要可追溯来源，强烈建议启用“添加来源文件/Sheet 列”。